<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="PhotoReportsLite" basedir="." default="compile">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${basedir}/lib/ant-contrib.jar"/>
        </classpath>
    </taskdef>
    <property name="release.dir" value="${basedir}/html/js/photoreports-release"/>
    <property name="js.source.path" value="${basedir}/html/js"/>
    <property name="web.build.path" value="${basedir}/web_build"/>
    <property name="web.build.path.built.js.release" value="${web.build.path}/html/js/photoreports-release"/>


    <target name="clean" description="Delete all generated files">
        <delete dir="${release.dir}" failonerror="false"/>
        <delete dir="${web.build.path}" failonerror="false"/>
    </target>

    <target name="compile" description="Compiles the Task">
        <outofdate>
        <sourcefiles>
           <fileset dir="${js.source.path}/photoreports" includes="**"/>
           <fileset file="${js.source.path}/prl.profile.js"/>
        </sourcefiles>
        <targetfiles path="${release.dir}"/>
        <sequential>
            <exec dir="${js.source.path}/util/buildscripts/" executable="${js.source.path}/util/buildscripts/build.sh">
                <arg line="releaseDir=${release.dir}/"/>
                <arg line="profileFile=${js.source.path}/prl.profile.js"/>
                <arg line="releaseName=dojo"/>
                <arg line="copyTests=false"/>
                <arg line="action=release"/>
                <arg line="optimize=shrinksafe"/>
            </exec>
        </sequential>
        </outofdate>
    </target>

    <target name="build-web" depends="compile">
        <sequential>
            <delete dir="${web.build.path}"/>
            <mkdir dir="${web.build.path}/html/js"/>
            <!--copy staff into build direcotry-->
            <copy todir="${web.build.path.built.js.release}">
               <fileset dir="${release.dir}"/>
            </copy>
            <copy todir="${web.build.path}/html">
                <fileset file="${basedir}/html/app-release.html"/>
            </copy>
            <copy todir="${web.build.path}">
                <fileset file="${basedir}/app.psgi"/>
                <fileset file="${basedir}/JsonProxy.pm"/>
                <fileset file="${basedir}/cpanm"/>
                <fileset file="${basedir}/carton.lock"/>
                <fileset file="${basedir}/Build.PL"/>
            </copy>
            <!--Delete unnecessary staff-->
            <delete>
                <fileset dir="${web.build.path.built.js.release}/dojo">
                    <include name="**/*"/>
                    <excludesfile name="${web.build.path.built.js.release}/dojo/dojox/mobile/themes/iphone/iphone.css"/>
                    <excludesfile name="${web.build.path.built.js.release}/dojo/dojo/dojo.js"/>
                </fileset>
            </delete>
        </sequential>

    </target>


</project>